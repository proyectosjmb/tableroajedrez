<!-- tablero_entrenamiento.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero de Entrenamiento (FEN)</title>

  <!-- Chessboard.js CSS (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#e9ecf1;
      --muted:#a8b0bf;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --cta:#4f7cff;
      --cta2:#2f60ff;
      --danger:#ff4f6d;
      --ok:#34d399;
      --radius:16px;
      --arrow: rgba(79,124,255,.92);
      --arrow2: rgba(79,124,255,.55);
      --markRed: rgba(255,79,109,.30);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(79,124,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(52,211,153,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .app{
      width:min(1100px, 100%);
      display:flex;
      gap:20px;
      align-items:stretch;
      justify-content:center;
      flex-wrap:wrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }

    .left{
      flex: 0 1 560px;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
    }

    .right{
      flex: 1 1 420px;
      min-width:min(420px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
      justify-content:center;
    }

    header{
      width:100%;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
      margin-bottom:6px;
    }

    header h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    header p{
      margin:4px 0 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .headerActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn-mini{
      padding:8px 10px;
      font-size:12px;
      border-radius:999px;
    }

    #boardWrap{
      width: min(92vw, 520px);
    }

    /* ‚Äúc√°scara‚Äù del tablero (para poder poner overlays encima) */
    #boardShell{
      width:100%;
      position:relative;
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    #board{
      width: 100%;
      /* el redondeo/overflow viven en #boardShell */
    }

    /* Capa SVG para flechas */
    #arrowLayer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index: 5; /* encima de piezas */
    }

    /* Asegura que las casillas acepten overlays */
    #board .square-55d63{
      position: relative;
    }

    /* Casillas marcadas en rojo (click derecho o Shift+Click) */
    #board .square-55d63.mark-red::after{
      content:"";
      position:absolute;
      inset:0;
      background: var(--markRed);
      z-index: 2;
    }

    /* Casilla seleccionada (click normal) */
    #board .square-55d63.sq-selected{
      box-shadow: inset 0 0 0 3px rgba(79,124,255,.85);
    }

    .statusBar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,.03);
    }

    .statusText{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--text);
      background: rgba(255,255,255,.04);
      user-select:none;
      white-space:nowrap;
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .input:focus{
      border-color: rgba(79,124,255,.55);
      box-shadow: 0 0 0 3px rgba(79,124,255,.18);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:11px 14px;
      border-radius:12px;
      font-weight:700;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-cta{
      background: linear-gradient(180deg, var(--cta), var(--cta2));
      border-color: rgba(79,124,255,.65);
    }
    .btn-cta:hover{ filter: brightness(1.03); }

    .btn-ghost:hover{ background: rgba(255,255,255,.06); }

    .btn-wide{
      width:100%;
      padding:14px 16px;
      font-size:14px;
      border-radius:14px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin:0;
      line-height:1.45;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(17,19,26,.92);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12.5px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 20;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .errorBox{
      display:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,79,109,.35);
      background: rgba(255,79,109,.10);
      color: #ffd1da;
      font-size:12.5px;
      line-height:1.35;
    }

    @media (max-width: 940px){
      .right{ min-width: 100%; }
      #boardWrap{ width: min(92vw, 560px); }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- IZQUIERDA: TABLERO -->
    <section class="card left">
      <div style="width:100%;">
        <header>
          <div>
            <h1>Tablero de entrenamiento</h1>
            <p>Click normal: flechas de jugadas posibles. Click derecho o Shift+Click: marcar casilla roja.</p>
          </div>

          <div class="headerActions">
            <button class="btn btn-ghost btn-mini" id="pasteFenBtn" type="button">üìã Pegar FEN y Cargar</button>
            <button class="btn btn-ghost btn-mini" id="clearMarksBtn" type="button">üßπ Limpiar marcas</button>
            <span class="pill" id="fenShort">FEN listo</span>
          </div>
        </header>
      </div>

      <div id="boardWrap">
        <div id="boardShell">
          <div id="board"></div>
          <svg id="arrowLayer" aria-hidden="true"></svg>
        </div>
      </div>

      <div class="statusBar">
        <p class="statusText" id="status">Turno: Blancas</p>
        <span class="pill" id="gameState">En juego</span>
      </div>
    </section>

    <!-- DERECHA: CONTROLES -->
    <aside class="card right">
      <div class="controls">
        <div>
          <p class="label">Pega una FEN aqu√≠</p>
          <input id="fenInput" class="input" type="text" spellcheck="false"
                 placeholder="Ej: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1" />
          <div class="errorBox" id="fenError"></div>
        </div>

        <div class="row">
          <button class="btn btn-ghost" id="loadFenBtn" type="button">Cargar Posici√≥n</button>
          <button class="btn btn-ghost" id="flipBtn" type="button">Girar Tablero</button>
        </div>

        <button class="btn btn-cta btn-wide" id="copyFenBtn" type="button">Copiar FEN Actual</button>

        <p class="hint">
          Tip: Promoci√≥n autom√°tica a dama (Q). Para limpiar flechas: click fuera del tablero o ‚ÄúLimpiar marcas‚Äù.
        </p>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast">Listo</div>

  <!-- Dependencias (orden importante) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
          crossorigin="anonymous"></script>

  <!-- Chess.js UMD (evita el problema de 'export') -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <!-- Chessboard.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    (function(){
      // --- Estado global
      var game = new Chess(); // l√≥gica (chess.js)
      var board = null;       // UI (chessboard.js)

      var isDragging = false;
      var selectedSquare = null;
      var markedRed = {}; // {e4:true, ...}

      // --- Helpers UI
      var $fenInput = $('#fenInput');
      var $fenError = $('#fenError');
      var $status   = $('#status');
      var $gameState= $('#gameState');
      var $fenShort = $('#fenShort');
      var $copyBtn  = $('#copyFenBtn');
      var $toast    = $('#toast');

      var $arrowLayer = $('#arrowLayer');
      var $boardShell = $('#boardShell');

      function showError(msg){
        $fenError.text(msg).show();
      }
      function clearError(){
        $fenError.hide().text('');
      }

      function showToast(msg){
        $toast.text(msg || 'Listo').addClass('show');
        setTimeout(function(){ $toast.removeClass('show'); }, 1400);
      }

      function safeFenBadge(fen){
        var parts = (fen || '').split(' ');
        if(parts.length < 6) return 'FEN listo';
        var side = parts[1] === 'w' ? 'w' : 'b';
        var move = parts[5];
        return 'Turno ' + (side === 'w' ? 'w' : 'b') + ' ¬∑ Jug ' + move;
      }

      function updateStatus(){
        var turn = game.turn() === 'w' ? 'Blancas' : 'Negras';
        var legalMoves = game.moves().length;

        if (legalMoves === 0) {
          if (game.in_check()) {
            $status.text('Jaque mate. Ganaron ' + (turn === 'Blancas' ? 'Negras' : 'Blancas') + '.');
            $gameState.text('Jaque mate');
            $gameState.css('border-color','rgba(255,79,109,.45)');
          } else {
            $status.text('Empate / tablas (ahogado).');
            $gameState.text('Tablas');
            $gameState.css('border-color','rgba(255,255,255,.18)');
          }
          $fenShort.text(safeFenBadge(game.fen()));
          return;
        }

        if (game.in_draw && game.in_draw()) {
          $status.text('Empate / tablas.');
          $gameState.text('Tablas');
          $gameState.css('border-color','rgba(255,255,255,.18)');
          $fenShort.text(safeFenBadge(game.fen()));
          return;
        }

        if (game.in_check && game.in_check()) {
          $status.text('Turno: ' + turn + ' (¬°Jaque!)');
          $gameState.text('Jaque');
          $gameState.css('border-color','rgba(79,124,255,.55)');
        } else {
          $status.text('Turno: ' + turn);
          $gameState.text('En juego');
          $gameState.css('border-color','rgba(255,255,255,.12)');
        }

        $fenShort.text(safeFenBadge(game.fen()));
      }

      // ---------------------------
      // Flechas (posibles jugadas)
      // ---------------------------
      function clearArrows(){
        $arrowLayer.empty();
      }

      function getSquareFromEl(el){
        var cls = el.className || '';
        var m = cls.match(/square-([a-h][1-8])/);
        return m ? m[1] : null;
      }

      function squareCenter(square){
        var sqEl = document.querySelector('#board .square-' + square);
        if(!sqEl) return null;
        var r = sqEl.getBoundingClientRect();
        var br = $boardShell[0].getBoundingClientRect();
        return {
          x: (r.left - br.left) + r.width/2,
          y: (r.top - br.top) + r.height/2,
          size: r.width
        };
      }

      function ensureSvgSize(){
        var br = $boardShell[0].getBoundingClientRect();
        $arrowLayer.attr('viewBox', '0 0 ' + br.width + ' ' + br.height);
        $arrowLayer.attr('preserveAspectRatio', 'none');
      }

      function drawArrowsFrom(square){
        clearArrows();
        ensureSvgSize();

        if(!square) return;

        var moves = [];
        try{
          // Permite mostrar jugadas posibles incluso si eliges una pieza del color que NO tiene el turno
          var piece = game.get(square); // {type:'p', color:'w'|'b'} o null
          var turnColor = game.turn();
          if(piece && piece.color && piece.color !== turnColor){
            // Clona la posici√≥n pero cambiando el turno para poder calcular movimientos legales de ese color
            var parts = game.fen().split(' ');
            if(parts.length >= 2){
              parts[1] = piece.color; // 'w' o 'b'
              var tmp = new Chess();
              if(tmp.load(parts.join(' '))){
                moves = tmp.moves({ square: square, verbose: true }) || [];
              }else{
                moves = [];
              }
            }
          }else{
            moves = game.moves({ square: square, verbose: true }) || [];
          }
        }catch(e){
          moves = [];
        }
        if(!moves.length) return;

        // Dedup por destino (promociones generan m√∫ltiples)
        var seen = {};
        var dedup = [];
        for(var i=0;i<moves.length;i++){
          var to = moves[i].to;
          if(seen[to]) continue;
          seen[to] = true;
          dedup.push({from: square, to: to});
        }

        var fromC = squareCenter(square);
        if(!fromC) return;

        var sw = Math.max(3, fromC.size * 0.10);
        var head = Math.max(8, fromC.size * 0.22);

        // SVG defs (arrowhead)
        var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        var marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        marker.setAttribute('id', 'arrowHead');
        marker.setAttribute('markerWidth', head);
        marker.setAttribute('markerHeight', head);
        marker.setAttribute('refX', head * 0.7);
        marker.setAttribute('refY', head * 0.5);
        marker.setAttribute('orient', 'auto');
        marker.setAttribute('markerUnits', 'userSpaceOnUse');

        var poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        poly.setAttribute('points', '0,0 ' + head + ',' + (head/2) + ' 0,' + head);
        poly.setAttribute('fill', 'var(--arrow)');
        marker.appendChild(poly);
        defs.appendChild(marker);
        $arrowLayer[0].appendChild(defs);

        for(var j=0;j<dedup.length;j++){
          var toC = squareCenter(dedup[j].to);
          if(!toC) continue;

          // ‚Äúrecorta‚Äù un poquito para que la flecha no tape el centro de la casilla destino
          var dx = toC.x - fromC.x;
          var dy = toC.y - fromC.y;
          var dist = Math.sqrt(dx*dx + dy*dy) || 1;
          var trim = Math.max(10, fromC.size * 0.18);
          var x2 = toC.x - (dx/dist)*trim;
          var y2 = toC.y - (dy/dist)*trim;

          var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', fromC.x);
          line.setAttribute('y1', fromC.y);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);
          line.setAttribute('stroke', 'var(--arrow)');
          line.setAttribute('stroke-width', sw);
          line.setAttribute('stroke-linecap', 'round');
          line.setAttribute('opacity', '0.92');
          line.setAttribute('marker-end', 'url(#arrowHead)');
          $arrowLayer[0].appendChild(line);
        }
      }

      function clearSelection(){
        selectedSquare = null;
        clearArrows();
        $('#board .square-55d63').removeClass('sq-selected');
      }

      function setSelectedSquare(square){
        $('#board .square-55d63').removeClass('sq-selected');
        selectedSquare = square;
        if(square){
          $('#board .square-' + square).addClass('sq-selected');
        }
        drawArrowsFrom(square);
      }

      // ---------------------------
      // Marcas rojas
      // ---------------------------
      function applyRedMark(square, on){
        var $sq = $('#board .square-' + square);
        if(on){
          markedRed[square] = true;
          $sq.addClass('mark-red');
        }else{
          delete markedRed[square];
          $sq.removeClass('mark-red');
        }
      }

      function toggleRed(square){
        if(!square) return;
        applyRedMark(square, !markedRed[square]);
      }

      function reapplyRedMarks(){
        $('#board .square-55d63').removeClass('mark-red');
        for(var sq in markedRed){
          if(markedRed.hasOwnProperty(sq)){
            $('#board .square-' + sq).addClass('mark-red');
          }
        }
      }

      // ---------------------------
      // Callbacks del tablero
      // ---------------------------
      function onDragStart(source, piece){
        isDragging = true;

        // Bloquea movimientos si el juego termin√≥
        if (game.game_over && game.game_over()) return false;

        // Solo permitir mover piezas del color del turno
        if (game.turn() === 'w' && piece.search(/^b/) !== -1) return false;
        if (game.turn() === 'b' && piece.search(/^w/) !== -1) return false;

        clearError();
        clearSelection(); // al arrastrar, quita flechas
      }

      function onDrop(source, target){
        var move = game.move({
          from: source,
          to: target,
          promotion: 'q'
        });

        if (move === null) return 'snapback';

        updateStatus();
      }

      function onSnapEnd(){
        isDragging = false;
        board.position(game.fen());
        // tras mover, se conservan marcas rojas, pero se quitan flechas
        clearSelection();
        reapplyRedMarks();
      }

      // ---------------------------
      // Init tablero
      // ---------------------------
      function initBoard(){
        board = Chessboard('board', {
          position: 'start',
          draggable: true,
          pieceTheme: 'https://huggingface.co/spaces/ggml-org/wchess/resolve/cff6aed24fdbaab44a699045dec13afd4f1a7e48/img/chesspieces/wikipedia/{piece}.png',
          onDragStart: onDragStart,
          onDrop: onDrop,
          onSnapEnd: onSnapEnd
        });

        updateStatus();
        ensureSvgSize();
      }

      // ---------------------------
      // FEN load helper
      // ---------------------------
      function loadFenFromString(fen, opts){
        opts = opts || {};
        fen = (fen || '').trim();

        if(!fen){
          showError('No hay texto para cargar como FEN.');
          return false;
        }

        var ok = false;
        try {
          ok = game.load(fen);
        } catch(e){
          ok = false;
        }

        if(!ok){
          showError('FEN inv√°lida. Revisa formato y espacios (debe tener 6 campos).');
          return false;
        }

        clearError();
        board.position(game.fen(), true);
        updateStatus();
        clearSelection();
        reapplyRedMarks();
        if(opts.toast) showToast(opts.toast);
        return true;
      }

      // ---------------------------
      // Acciones de botones
      // ---------------------------
      $('#loadFenBtn').on('click', function(){
        loadFenFromString($fenInput.val(), { toast: 'Posici√≥n cargada' });
      });

      $('#flipBtn').on('click', function(){
        board.flip();
        ensureSvgSize();
        if(selectedSquare) drawArrowsFrom(selectedSquare);
        showToast('Tablero girado');
      });

      $('#clearMarksBtn').on('click', function(){
        markedRed = {};
        clearSelection();
        reapplyRedMarks();
        showToast('Marcas limpiadas');
      });

      // Pegado r√°pido: lee portapapeles -> input -> carga
      $('#pasteFenBtn').on('click', async function(){
        clearError();

        if(!navigator.clipboard || !navigator.clipboard.readText){
          showError('Tu navegador no permite leer el portapapeles aqu√≠. Pega manualmente la FEN en el campo y usa ‚ÄúCargar Posici√≥n‚Äù.');
          $fenInput.focus();
          return;
        }

        try{
          var text = await navigator.clipboard.readText();
          $fenInput.val((text || '').trim());
          var ok = loadFenFromString(text, { toast: 'FEN pegada y cargada' });
          if(!ok){
            // si fall√≥, deja el texto en el input para que lo edites
            $fenInput.focus();
          }
        }catch(err){
          // Lo m√°s com√∫n: abrir como file:// o permiso denegado
          showError('No pude leer el portapapeles. Abre esta p√°gina desde un servidor (por ejemplo GitHub Pages o localhost) y permite el permiso de portapapeles. Tambi√©n puedes pegar manualmente la FEN en el campo.');
          $fenInput.focus();
        }
      });

      function copyToClipboard(text){
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text);
        }
        return new Promise(function(resolve, reject){
          try{
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            var ok = document.execCommand('copy');
            document.body.removeChild(ta);
            ok ? resolve() : reject(new Error('copy_failed'));
          }catch(err){
            reject(err);
          }
        });
      }

      $('#copyFenBtn').on('click', function(){
        var fen = game.fen();
        copyToClipboard(fen)
          .then(function(){
            var original = $copyBtn.text();
            $copyBtn.text('¬°Copiado!');
            showToast('FEN copiada');
            setTimeout(function(){ $copyBtn.text(original); }, 2000);
          })
          .catch(function(){
            showToast('No se pudo copiar');
            showError('No pude copiar al portapapeles (permiso del navegador). Copia manualmente: ' + fen);
          });
      });

      // ---------------------------
      // Interacci√≥n en tablero (flechas / marcas)
      // ---------------------------
      // Click normal: seleccionar casilla -> flechas de jugadas posibles (si hay)
      // Shift+Click o Click derecho: marcar casilla en rojo
      $('#board').on('click', '.square-55d63', function(e){
        if(isDragging) return;

        var sq = getSquareFromEl(this);
        if(!sq) return;

        if(e.shiftKey){
          toggleRed(sq);
          return;
        }

        // Click normal
        if(selectedSquare === sq){
          clearSelection();
        }else{
          setSelectedSquare(sq);
        }
      });

      // Click derecho: marcar en rojo (sin men√∫)
      $('#board').on('contextmenu', '.square-55d63', function(e){
        e.preventDefault();
        if(isDragging) return;
        var sq = getSquareFromEl(this);
        toggleRed(sq);
      });

      // Click fuera del tablero: limpia flechas/selecci√≥n (no borra marcas rojas)
      $(document).on('mousedown', function(e){
        if($(e.target).closest('#boardShell').length === 0){
          clearSelection();
        }
      });

      // Tecla ESC: limpia flechas/selecci√≥n
      $(document).on('keydown', function(e){
        if(e.key === 'Escape'){
          clearSelection();
        }
      });

      // --- Responsivo: re-calcular tama√±o del tablero + flechas
      function resizeBoard(){
        if(board && board.resize) board.resize();
        ensureSvgSize();
        if(selectedSquare) drawArrowsFrom(selectedSquare);
        reapplyRedMarks();
      }
      $(window).on('resize', function(){
        resizeBoard();
      });

      // --- Arranque
      initBoard();
    })();
  </script>
</body>
</html>
